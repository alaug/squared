<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squared</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        body.game-active {
            background: #f5f5f5;
        }

        .game-container-wrapper {
            position: relative;
            width: 100%;
            max-width: 650px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
        }

        .game-back-button {
            position: absolute;
            top: -50px;
            left: 0;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #333;
            padding: 10px;
            z-index: 10;
        }

        .game-back-button:hover {
            color: #1E9FD8;
        }

        h1 {
            text-align: center;
            color: #b8a4d4;
            margin-bottom: 25px;
            font-size: 2.2em;
            font-weight: 300;
            letter-spacing: 8px;
            text-transform: uppercase;
        }

        .top-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 20px;
        }

        .timer-section {
            flex: 1;
            text-align: left;
        }

        .timer {
            color: #ffb3ba;
            font-size: 1.3em;
            font-weight: 600;
        }

        .pattern-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .score-section {
            flex: 1;
            text-align: right;
        }

        .score {
            color: #bae1ff;
            font-size: 1.3em;
            font-weight: 600;
        }

        .pattern-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pattern-label {
            text-align: center;
            font-weight: 500;
            margin-bottom: 8px;
            color: #888;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pattern {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            width: fit-content;
            margin: 0 auto;
        }

        .pattern-square {
            width: 35px;
            height: 35px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 22px;
            margin-bottom: 20px;
            padding: 10px;
            max-width: 75%;
            margin-left: auto;
            margin-right: auto;
        }

        .square {
            aspect-ratio: 1;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .square:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .square.selected {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(184, 164, 212, 0.5);
        }

        .square.hint {
            animation: gentleGlow 2s ease-in-out infinite;
        }

        .square.wrong {
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        @keyframes gentleGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4), 0 0 0 3px rgba(255, 215, 0, 0.5);
            }
            50% {
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 0 45px rgba(255, 215, 0, 0.6), 0 0 0 3px rgba(255, 215, 0, 0.7);
            }
        }

        .selection-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .message {
            text-align: center;
            font-size: 0.95em;
            font-weight: 500;
            min-height: 25px;
            margin-bottom: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message.show {
            opacity: 1;
        }

        .message.success {
            color: #baffc9;
        }

        .message.error {
            color: #ffb3ba;
        }

        .button {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            font-weight: 500;
            border: 2px solid #b8a4d4;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            color: #b8a4d4;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            background: #b8a4d4;
            color: white;
        }

        .button:disabled {
            background: #f0f0f0;
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }

        .game-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            margin-top: 20px;
        }

        .action-item {
            text-align: center;
            padding: 20px 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid #e0e0e0;
            border-top: 3px solid #1E9FD8;
        }

        .action-item.depleted {
            border-top: 3px solid transparent;
        }

        .action-item:last-child {
            border-right: none;
        }

        .action-item:hover {
            background: #f5f5f5;
        }

        .action-count {
            font-size: 2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .action-label {
            font-size: 0.9em;
            color: #999;
            text-transform: lowercase;
        }

        .game-over {
            text-align: center;
        }

        .game-over h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .final-score {
            font-size: 2em;
            color: #27ae60;
            margin: 20px 0;
        }

        /* Home Screen Styles */
        .home-screen {
            text-align: center;
            color: #333;
            background: #f5f5f5;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 60px;
        }

        .logo-icon {
            display: grid;
            grid-template-columns: repeat(2, 36px);
            grid-template-rows: repeat(2, 36px);
            gap: 3.6px;
        }

        .logo-square {
            background: #1E9FD8;
            border-radius: 3px;
            position: relative;
        }

        .logo-square.hollow::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14.4px;
            height: 14.4px;
            background: white;
            border-radius: 2px;
        }

        .home-screen h1 {
            font-size: 3.5em;
            font-weight: 300;
            letter-spacing: 2px;
            color: #333;
            margin: 0;
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 250px;
        }

        .menu-button {
            background: white;
            color: #333;
            border: none;
            padding: 18px 30px;
            font-size: 1.1em;
            font-weight: 400;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #fafafa;
        }

        .menu-icon {
            display: grid;
            grid-template-columns: repeat(2, 12px);
            grid-template-rows: repeat(2, 12px);
            gap: 2px;
        }

        .menu-icon-square {
            background: #1E9FD8;
            border-radius: 2px;
        }

        .decorative-squares {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .decorative-pattern {
            position: absolute;
            display: grid;
            grid-template-columns: repeat(2, 30px);
            grid-template-rows: repeat(2, 30px);
            gap: 3px;
            opacity: 0.3;
        }

        .decorative-pattern.top-right {
            top: 30px;
            right: 60px;
        }

        .decorative-pattern.top-right-small {
            top: 50px;
            right: 30px;
            grid-template-columns: repeat(2, 20px);
            grid-template-rows: repeat(2, 20px);
        }

        .decorative-pattern.bottom-left {
            bottom: 100px;
            left: 30px;
        }

        .decorative-pattern.bottom-left-small {
            bottom: 50px;
            left: 10px;
            grid-template-columns: repeat(2, 20px);
            grid-template-rows: repeat(2, 20px);
        }

        .decorative-pattern.middle-left {
            top: 50%;
            left: 50px;
            transform: translateY(-50%);
        }

        .decorative-pattern.middle-right {
            top: 40%;
            right: 40px;
        }

        .decorative-pattern.bottom-right {
            bottom: 150px;
            right: 80px;
            grid-template-columns: repeat(2, 25px);
            grid-template-rows: repeat(2, 25px);
        }

        .decorative-square {
            background: #bae1ff;
            border-radius: 2px;
        }

        .start-button {
            background: white;
            color: #000;
            border: none;
            padding: 20px 80px;
            font-size: 1.3em;
            font-weight: 500;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.5);
        }

        /* More Page Styles */
        .more-screen-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
        }

        .more-screen {
            background: white;
            width: 100%;
            padding: 30px;
            box-sizing: border-box;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-height: 600px;
        }

        .more-back-button {
            position: absolute;
            top: -50px;
            left: 0;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #333;
            padding: 10px;
        }

        .more-back-button:hover {
            color: #1E9FD8;
        }

        .more-header {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 30px;
            color: #333;
        }

        .more-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .more-tab {
            background: none;
            border: none;
            font-size: 1.3em;
            padding: 10px 5px;
            cursor: pointer;
            color: #999;
            position: relative;
            transition: color 0.3s;
        }

        .more-tab.active {
            color: #333;
            font-weight: 500;
        }

        .more-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #333;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .setting-label {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .username-input {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .username-input:focus {
            outline: none;
            border-color: #1E9FD8;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-label {
            font-size: 1em;
            color: #333;
        }

        .toggle-switch {
            position: relative;
            width: 80px;
            height: 32px;
            background: #e0e0e0;
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.3s;
            border: 2px solid #333;
        }

        .toggle-switch.active {
            background: #1E9FD8;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            border: 2px solid #333;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(48px);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: auto repeat(5, 50px);
            gap: 15px;
            align-items: center;
        }

        .theme-row {
            display: contents;
        }

        .theme-radio {
            width: 30px;
            height: 30px;
            border: 2px solid #333;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            background: white;
        }

        .theme-radio.selected::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: #333;
            border-radius: 50%;
        }

        .theme-color {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .theme-color:hover {
            transform: scale(1.1);
        }

        .back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #333;
            padding: 10px;
        }

        .back-button:hover {
            color: #1E9FD8;
        }
    </style>
</head>
<body>
    <div id="homeScreen" class="home-screen">
        <div class="decorative-squares">
            <!-- Top right patterns -->
            <div class="decorative-pattern top-right-small">
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
            </div>
            
            <!-- Middle left pattern -->
            <div class="decorative-pattern middle-left">
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
            </div>
            
            <!-- Middle right pattern -->
            <div class="decorative-pattern middle-right">
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
            </div>
            
            <!-- Bottom left patterns -->
            <div class="decorative-pattern bottom-left">
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
            </div>
            <div class="decorative-pattern bottom-left-small">
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
            </div>
            
            <!-- Bottom right pattern -->
            <div class="decorative-pattern bottom-right">
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
                <div class="decorative-square"></div>
            </div>
        </div>
        
        <div class="logo-container">
            <div class="logo-icon">
                <div class="logo-square"></div>
                <div class="logo-square hollow"></div>
                <div class="logo-square hollow"></div>
                <div class="logo-square"></div>
            </div>
            <h1>Squared</h1>
        </div>
        
        <div class="menu">
            <button class="menu-button" onclick="showGame()">
                <div class="menu-icon">
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                </div>
                Play
            </button>
            <button class="menu-button" onclick="alert('Stats coming soon!')">
                <div class="menu-icon">
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                </div>
                Stats
            </button>
            <button class="menu-button" onclick="alert('Tutorial coming soon!')">
                <div class="menu-icon">
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                </div>
                Tutorial
            </button>
            <button class="menu-button" onclick="showMore()">
                <div class="menu-icon">
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                    <div class="menu-icon-square"></div>
                </div>
                More
            </button>
        </div>
    </div>

    <div id="moreScreen" class="more-screen-wrapper" style="display: none;">
        <button class="more-back-button" onclick="showHome()">←</button>
        
        <div class="more-screen">
            <h2 class="more-header">MORE</h2>
        
        <div class="more-tabs">
            <button class="more-tab active" onclick="showSettingsTab()">settings</button>
            <button class="more-tab" onclick="showAboutTab()">about</button>
        </div>
        
        <div id="settingsTab">
            <div class="settings-section">
                <div class="setting-label">username</div>
                <input type="text" class="username-input" id="usernameInput" value="{username}" placeholder="Enter username">
            </div>
            
                       
            <div class="settings-section">
                <div class="setting-label">theme</div>
                <div class="theme-grid">
                    <!-- Row 1 -->
                    <div class="theme-radio selected" onclick="selectTheme(0)"></div>
                    <div class="theme-color" style="background: #7FD45E;" onclick="selectTheme(0)"></div>
                    <div class="theme-color" style="background: #E8479D;" onclick="selectTheme(0)"></div>
                    <div class="theme-color" style="background: #FFA826;" onclick="selectTheme(0)"></div>
                    <div class="theme-color" style="background: #1E9FD8;" onclick="selectTheme(0)"></div>
                    <div class="theme-color" style="background: #7E8FD4;" onclick="selectTheme(0)"></div>
                    
                    <!-- Row 2 -->
                    <div class="theme-radio" onclick="selectTheme(1)"></div>
                    <div class="theme-color" style="background: #F5A623;" onclick="selectTheme(1)"></div>
                    <div class="theme-color" style="background: #7ED4D1;" onclick="selectTheme(1)"></div>
                    <div class="theme-color" style="background: #EC8C99;" onclick="selectTheme(1)"></div>
                    <div class="theme-color" style="background: #8FD47E;" onclick="selectTheme(1)"></div>
                    <div class="theme-color" style="background: #C96565;" onclick="selectTheme(1)"></div>
                    
                    <!-- Row 3 -->
                    <div class="theme-radio" onclick="selectTheme(2)"></div>
                    <div class="theme-color" style="background: #6B9370;" onclick="selectTheme(2)"></div>
                    <div class="theme-color" style="background: #B5D4A1;" onclick="selectTheme(2)"></div>
                    <div class="theme-color" style="background: #A8CEE2;" onclick="selectTheme(2)"></div>
                    <div class="theme-color" style="background: #D4C89E;" onclick="selectTheme(2)"></div>
                    <div class="theme-color" style="background: #E8B4B8;" onclick="selectTheme(2)"></div>
                    
                    <!-- Row 4 -->
                    <div class="theme-radio" onclick="selectTheme(3)"></div>
                    <div class="theme-color" style="background: #2D3436;" onclick="selectTheme(3)"></div>
                    <div class="theme-color" style="background: #4A5F8C;" onclick="selectTheme(3)"></div>
                    <div class="theme-color" style="background: #B8C5E0;" onclick="selectTheme(3)"></div>
                    <div class="theme-color" style="background: #F4E63D;" onclick="selectTheme(3)"></div>
                    <div class="theme-color" style="background: #9BA653;" onclick="selectTheme(3)"></div>
                </div>
            </div>
        </div>
        
        <div id="aboutTab" style="display: none;">
            <p style="margin-bottom: 20px;">created by: <strong>Austin Laugesen</strong></p>
            <p style="margin-bottom: 20px;">email: <a href="mailto:alaug@outlook.com" style="color: #1E9FD8; text-decoration: none;">alaug@outlook.com</a></p>
            <p style="margin-bottom: 20px; color: #999;">version: 1.0.0.0</p>
            
        </div>
        </div>
    </div>

    <div id="gameContainer" class="game-container-wrapper" style="display: none;">
        <button class="game-back-button" onclick="backToHome()">←</button>
        
        <div class="game-container">
            <div id="gameScreen">
            <div class="top-section">
                <div class="timer-section">
                    <div class="timer"><span id="timer">60</span>s</div>
                </div>
                
                <div class="pattern-section">
                    <div class="pattern-container">
                        <div class="pattern" id="pattern"></div>
                    </div>
                </div>
                
                <div class="score-section">
                    <div class="score"><span id="score">0</span></div>
                </div>
            </div>

            <div class="message" id="message"></div>

            <div class="grid" id="grid"></div>

            <div class="game-actions">
                <div class="action-item" id="hintsAction" onclick="useHint()">
                    <div class="action-count"><span id="hintsCount">5</span></div>
                    <div class="action-label">hints</div>
                </div>
                <div class="action-item" id="skipsAction" onclick="useSkip()">
                    <div class="action-count"><span id="skipsCount">5</span></div>
                    <div class="action-label">skips</div>
                </div>
                <div class="action-item" id="clockStopsAction" onclick="useClockStop()">
                    <div class="action-count"><span id="clockStopsCount">5</span></div>
                    <div class="action-label">clock stops</div>
                </div>
            </div>
        </div>

        <div id="gameOverScreen" style="display: none;" class="game-over">
            <h2>Game Over!</h2>
            <div class="final-score">Final Score: <span id="finalScore">0</span></div>
            <button class="button" onclick="startGame()">Play Again</button>
        </div>
        </div>
    </div>

    <script>
        // Color themes matching the More page
        const COLOR_THEMES = [
            ['#7FD45E', '#E8479D', '#FFA826', '#1E9FD8', '#7E8FD4'], // Theme 0 - Default
            ['#F5A623', '#7ED4D1', '#EC8C99', '#8FD47E', '#C96565'], // Theme 1
            ['#6B9370', '#B5D4A1', '#A8CEE2', '#D4C89E', '#E8B4B8'], // Theme 2
            ['#2D3436', '#4A5F8C', '#B8C5E0', '#F4E63D', '#9BA653']  // Theme 3
        ];
        
        const GRID_SIZE = 5;
        let grid = [];
        let pattern = [];
        let selectedSquares = [];
        let score = 0;
        let timeLeft = 60;
        let timer = null;
        let validSolutions = [];
        let hintSquare = null;
        let selectedThemeIndex = 0;
        let currentColors = COLOR_THEMES[0];
        let hintsRemaining = 5;
        let skipsRemaining = 5;
        let clockStopsRemaining = 5;

        function showHome() {
            document.getElementById('homeScreen').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('moreScreen').style.display = 'none';
            document.body.classList.remove('game-active');
        }

        function backToHome() {
            clearInterval(timer);
            showHome();
        }

        function showMore() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('moreScreen').style.display = 'block';
        }

        function showSettingsTab() {
            document.querySelectorAll('.more-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('settingsTab').style.display = 'block';
            document.getElementById('aboutTab').style.display = 'none';
        }

        function showAboutTab() {
            document.querySelectorAll('.more-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('aboutTab').style.display = 'block';
        }

        function selectTheme(index) {
            selectedThemeIndex = index;
            currentColors = COLOR_THEMES[index];
            document.querySelectorAll('.theme-radio').forEach((radio, i) => {
                if (i === index) {
                    radio.classList.add('selected');
                } else {
                    radio.classList.remove('selected');
                }
            });
        }

        function showGame() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('moreScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            document.body.classList.add('game-active');
            startGame();
        }

        function startGame() {
            score = 0;
            timeLeft = 60;
            selectedSquares = [];
            hintsRemaining = 5;
            skipsRemaining = 5;
            clockStopsRemaining = 5;
            
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';
            
            updateDisplay();
            generateLevel();
        }

        function generateLevel() {
            clearInterval(timer);
            selectedSquares = [];
            hintSquare = null;
            timeLeft = 60;
            
            // Generate random grid
            grid = [];
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                grid.push(currentColors[Math.floor(Math.random() * currentColors.length)]);
            }

            // Generate pattern and ensure at least one solution exists
            generatePatternWithSolution();
            
            console.log('Valid solutions found:', validSolutions.length);
            
            renderGrid();
            renderPattern();
            updateDisplay();
            startTimer();
        }

        function generatePatternWithSolution() {
            // Generate 4 random colors for the pattern
            pattern = [];
            for (let i = 0; i < 4; i++) {
                pattern.push(currentColors[Math.floor(Math.random() * currentColors.length)]);
            }
            
            // Pick a random starting position
            let startRow = Math.floor(Math.random() * (GRID_SIZE - 1));
            let startCol = Math.floor(Math.random() * (GRID_SIZE - 1));
            
            // Create a guaranteed solution (2x2 grouped pattern)
            const guaranteedSolution = [
                startRow * GRID_SIZE + startCol,
                startRow * GRID_SIZE + startCol + 1,
                (startRow + 1) * GRID_SIZE + startCol,
                (startRow + 1) * GRID_SIZE + startCol + 1
            ];
            
            // Place the pattern on the grid at this location
            guaranteedSolution.forEach((idx, i) => {
                grid[idx] = pattern[i];
            });
            
            // Find all valid solutions (including the guaranteed one)
            validSolutions = findAllSolutions();
            
            console.log('Guaranteed solution placed at:', guaranteedSolution);
        }

        function findGroupedPattern(startIdx) {
            const row = Math.floor(startIdx / GRID_SIZE);
            const col = startIdx % GRID_SIZE;
            const directions = [
                [0, 1], [1, 0], [0, -1], [-1, 0]  // right, down, left, up
            ];
            
            const pattern = [grid[startIdx]];
            let currentRow = row;
            let currentCol = col;
            
            for (let i = 0; i < 3; i++) {
                const validMoves = directions.filter(([dr, dc]) => {
                    const newRow = currentRow + dr;
                    const newCol = currentCol + dc;
                    return newRow >= 0 && newRow < GRID_SIZE && newCol >= 0 && newCol < GRID_SIZE;
                });
                
                if (validMoves.length > 0) {
                    const [dr, dc] = validMoves[Math.floor(Math.random() * validMoves.length)];
                    currentRow += dr;
                    currentCol += dc;
                    pattern.push(grid[currentRow * GRID_SIZE + currentCol]);
                }
            }
            
            return pattern;
        }

        function findEquidistantPattern(startIdx) {
            const row = Math.floor(startIdx / GRID_SIZE);
            const col = startIdx % GRID_SIZE;
            
            // Try to create an equidistant pattern (horizontal, vertical, or diagonal)
            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1]  // horizontal, vertical, diagonal right, diagonal left
            ];
            
            const validDir = directions.find(([dr, dc]) => {
                const lastRow = row + dr * 3;
                const lastCol = col + dc * 3;
                return lastRow >= 0 && lastRow < GRID_SIZE && lastCol >= 0 && lastCol < GRID_SIZE;
            });
            
            if (validDir) {
                const [dr, dc] = validDir;
                return [
                    grid[startIdx],
                    grid[(row + dr) * GRID_SIZE + (col + dc)],
                    grid[(row + dr * 2) * GRID_SIZE + (col + dc * 2)],
                    grid[(row + dr * 3) * GRID_SIZE + (col + dc * 3)]
                ];
            }
            
            // Fallback to grouped if equidistant not possible
            return findGroupedPattern(startIdx);
        }

        function findAllSolutions() {
            const solutions = [];
            
            // Check all possible starting positions
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                if (grid[i] === pattern[0]) {
                    // Check grouped patterns
                    const groupedSolutions = findGroupedSolutions(i);
                    solutions.push(...groupedSolutions);
                    
                    // Check equidistant patterns
                    const equidistantSolutions = findEquidistantSolutions(i);
                    solutions.push(...equidistantSolutions);
                }
            }
            
            return solutions;
        }

        function findGroupedSolutions(startIdx) {
            const solutions = [];
            const visited = new Set();
            
            function dfs(idx, path) {
                if (path.length === 4) {
                    if (path.every((p, i) => grid[p] === pattern[i])) {
                        const sortedPath = [...path].sort((a, b) => a - b).join(',');
                        if (!visited.has(sortedPath)) {
                            visited.add(sortedPath);
                            solutions.push([...path]);
                        }
                    }
                    return;
                }
                
                const row = Math.floor(idx / GRID_SIZE);
                const col = idx % GRID_SIZE;
                const neighbors = [
                    [row - 1, col], [row + 1, col], [row, col - 1], [row, col + 1]
                ];
                
                for (const [r, c] of neighbors) {
                    if (r >= 0 && r < GRID_SIZE && c >= 0 && c < GRID_SIZE) {
                        const nextIdx = r * GRID_SIZE + c;
                        if (!path.includes(nextIdx) && grid[nextIdx] === pattern[path.length]) {
                            dfs(nextIdx, [...path, nextIdx]);
                        }
                    }
                }
            }
            
            dfs(startIdx, [startIdx]);
            return solutions;
        }

        function findEquidistantSolutions(startIdx) {
            const solutions = [];
            const row = Math.floor(startIdx / GRID_SIZE);
            const col = startIdx % GRID_SIZE;
            
            // Check all possible directions and distances
            for (let dr = -3; dr <= 3; dr++) {
                for (let dc = -3; dc <= 3; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    
                    const indices = [];
                    let valid = true;
                    
                    for (let i = 0; i < 4; i++) {
                        const r = row + dr * i;
                        const c = col + dc * i;
                        
                        if (r < 0 || r >= GRID_SIZE || c < 0 || c >= GRID_SIZE) {
                            valid = false;
                            break;
                        }
                        
                        const idx = r * GRID_SIZE + c;
                        if (grid[idx] !== pattern[i]) {
                            valid = false;
                            break;
                        }
                        
                        indices.push(idx);
                    }
                    
                    if (valid) {
                        solutions.push(indices);
                    }
                }
            }
            
            return solutions;
        }

        function renderGrid() {
            const gridElement = document.getElementById('grid');
            gridElement.innerHTML = '';
            
            grid.forEach((color, index) => {
                const square = document.createElement('div');
                square.className = 'square';
                square.style.backgroundColor = color;
                square.dataset.index = index;
                square.onclick = () => selectSquare(index);
                gridElement.appendChild(square);
            });
        }

        function renderPattern() {
            const patternElement = document.getElementById('pattern');
            patternElement.innerHTML = '';
            
            pattern.forEach(color => {
                const square = document.createElement('div');
                square.className = 'pattern-square';
                square.style.backgroundColor = color;
                patternElement.appendChild(square);
            });
        }

        function selectSquare(index) {
            if (selectedSquares.includes(index)) {
                selectedSquares = selectedSquares.filter(i => i !== index);
            } else if (selectedSquares.length < 4) {
                selectedSquares.push(index);
            }
            
            updateSquareDisplay();
            updateDisplay();
            
            if (selectedSquares.length === 4) {
                checkSolution();
            }
        }

        function updateSquareDisplay() {
            document.querySelectorAll('.square').forEach(square => {
                const index = parseInt(square.dataset.index);
                square.classList.remove('selected', 'hint');
                if (selectedSquares.includes(index)) {
                    square.classList.add('selected');
                } else if (hintSquare === index) {
                    square.classList.add('hint');
                }
            });
        }

        function checkSolution() {
            if (selectedSquares.length !== 4) return;
            
            // Get positions and colors of selected squares
            const positions = selectedSquares.map(idx => ({
                idx: idx,
                row: Math.floor(idx / GRID_SIZE),
                col: idx % GRID_SIZE,
                color: grid[idx]
            }));
            
            // Sort positions to get top-left, top-right, bottom-left, bottom-right order
            positions.sort((a, b) => {
                if (a.row !== b.row) return a.row - b.row; // Sort by row first
                return a.col - b.col; // Then by column
            });
            
            // Pattern array is: [top-left, top-right, bottom-left, bottom-right]
            // So we need to reorder sorted positions to match this pattern layout
            const topLeft = positions[0];
            const topRight = positions[1];
            const bottomLeft = positions[2];
            const bottomRight = positions[3];
            
            // Check if colors match the pattern in the correct positions
            const colorsMatch = 
                grid[topLeft.idx] === pattern[0] &&
                grid[topRight.idx] === pattern[1] &&
                grid[bottomLeft.idx] === pattern[2] &&
                grid[bottomRight.idx] === pattern[3];
            
            if (!colorsMatch) {
                // Subtle shake on wrong squares
                selectedSquares.forEach(idx => {
                    const square = document.querySelector(`[data-index="${idx}"]`);
                    square.classList.add('wrong');
                    setTimeout(() => square.classList.remove('wrong'), 400);
                });
                
                setTimeout(() => {
                    selectedSquares = [];
                    updateSquareDisplay();
                    updateDisplay();
                }, 50);
                return;
            }
            
            // Check if it's a valid solution ( equidistant)
            const isValid = isEquidistant(topLeft, topRight, bottomLeft, bottomRight);
            
            if (isValid) {
                showMessage('Perfect! ✓', 'success');
                score += 40; // 10 points per square
                
                setTimeout(() => {
                    showMessage('', '');
                    generateLevel();
                }, 300);
            } else {
                // Subtle shake on wrong pattern type
                selectedSquares.forEach(idx => {
                    const square = document.querySelector(`[data-index="${idx}"]`);
                    square.classList.add('wrong');
                    setTimeout(() => square.classList.remove('wrong'), 400);
                });
                
                setTimeout(() => {
                    selectedSquares = [];
                    updateSquareDisplay();
                    updateDisplay();
                }, 500);
            }
        }

        function isEquidistant(topLeft, topRight, bottomLeft, bottomRight) {
            if (!topLeft || !topRight || !bottomLeft || !bottomRight) return false;
          
            /* TODO - fix the bug in isEquidistant*/
            // Calculate distances
            // 0 and 1 are row one
            // 2 and 3 are row two
            const deltaTopRightToTopLeft = topRight.col - topLeft.col;
            const deltaBottomRightToBottomLeft = bottomRight.col - bottomLeft.col;
            const deltaBottomLeftToTopLeft = bottomLeft.row - topLeft.row;
            const deltaBottomRightToTopRight = bottomRight.row - topRight.row;

            return (deltaTopRightToTopLeft === deltaBottomRightToBottomLeft) &&
                   (deltaBottomLeftToTopLeft === deltaBottomRightToTopRight &&
                     (deltaTopRightToTopLeft === deltaBottomLeftToTopLeft));
        }

        function resetSelection() {
            selectedSquares = [];
            updateSquareDisplay();
            updateDisplay();
            showMessage('', '');
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                updateDisplay();
                
                // Show hint every 5 seconds (at 15s, 10s, 5s)
                if (timeLeft % 5 === 0 && timeLeft > 0 && validSolutions.length > 0) {
                    console.log('Showing hint at', timeLeft, 'seconds');
                    showHint();
                }
                
                if (timeLeft <= 0) {
                    gameOver();
                }
            }, 1000);
        }

        function showHint() {
            // Pick a random valid solution and highlight the first square
            const randomSolution = validSolutions[Math.floor(Math.random() * validSolutions.length)];
            hintSquare = randomSolution[0];
            console.log('Hint square:', hintSquare, 'from solution:', randomSolution);
            updateSquareDisplay();
        }

        function gameOver() {
            clearInterval(timer);
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            document.getElementById('finalScore').textContent = score;
            
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            if (text) {
                messageEl.textContent = text;
                messageEl.className = 'message ' + type + ' show';
            } else {
                messageEl.classList.remove('show');
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = 'message';
                }, 300);
            }
        }

        function updateDisplay() {
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('score').textContent = score;
            document.getElementById('hintsCount').textContent = hintsRemaining;
            document.getElementById('skipsCount').textContent = skipsRemaining;
            document.getElementById('clockStopsCount').textContent = clockStopsRemaining;
            
            // Update border visibility based on remaining counts
            const hintsAction = document.getElementById('hintsAction');
            const skipsAction = document.getElementById('skipsAction');
            const clockStopsAction = document.getElementById('clockStopsAction');
            
            if (hintsRemaining === 0) {
                hintsAction.classList.add('depleted');
            } else {
                hintsAction.classList.remove('depleted');
            }
            
            if (skipsRemaining === 0) {
                skipsAction.classList.add('depleted');
            } else {
                skipsAction.classList.remove('depleted');
            }
            
            if (clockStopsRemaining === 0) {
                clockStopsAction.classList.add('depleted');
            } else {
                clockStopsAction.classList.remove('depleted');
            }
        }

        function useHint() {
            if (hintsRemaining > 0 && validSolutions.length > 0) {
                hintsRemaining--;
                const randomSolution = validSolutions[Math.floor(Math.random() * validSolutions.length)];
                hintSquare = randomSolution[0];
                updateSquareDisplay();
                updateDisplay();
                
                // Clear hint after 3 seconds
                setTimeout(() => {
                    hintSquare = null;
                    updateSquareDisplay();
                }, 3000);
            }
        }

        function useSkip() {
            if (skipsRemaining > 0) {
                skipsRemaining--;
                
                updateDisplay();
                generateLevel();
            }
        }

        function useClockStop() {
            if (clockStopsRemaining > 0) {
                clockStopsRemaining--;
                timeLeft += 10; // Add 10 seconds
                updateDisplay();
            }
        }
    </script>
</body>
</html>