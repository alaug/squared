<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f5f5f5">
    <title>Squared</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="screens">
    <div id="homeScreen" class="screen home-screen active">
        <div class="home-core">
            <div class="decorative-squares">
                <div class="decorative-pattern top-right"></div>
                <div class="decorative-pattern top-right-small"></div>
                <!--<div class="decorative-pattern middle-left"></div>-->
                <div class="decorative-pattern middle-right"></div>
                <div class="decorative-pattern bottom-left"></div>
                <div class="decorative-pattern bottom-left-small"></div>
                <!--<div class="decorative-pattern bottom-right"></div>-->
            </div>
            <div class="logo-container">
                <div class="logo-icon">
                    <div class="logo-square"></div>
                    <div class="logo-square hollow"></div>
                    <div class="logo-square hollow"></div>
                    <div class="logo-square"></div>
                </div>
                <p style="font-size: 42px;">Squared</p>
            </div>
            <div class="menu" id="mainMenu"></div>
        </div>
    </div>

    <div id="tutorialScreen" class="screen screen-wrapper">
        <header class="screen-header">
            <button class="back-btn" onclick="showScreen('home')">
                <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <h2>Tutorial</h2>
        </header>
        <div class="screen-content">
            <div class="tabs" id="tutorialTabs"></div>
            <div id="tutorialBasics" class="tab-panel active" data-tab-panel="basics">
                <div class="tutorial-top">
                    <div class="tutorial-description">
                        <p>Find four squares that match the pattern and form the corners of a larger square.</p>
                    </div>
                </div>
                <div class="tutorial-grid-wrapper">
                    <div class="tutorial-pattern-block">
                        <div class="pattern-label">Pattern to match</div>
                        <div class="pattern" id="tutorialPattern"></div>
                    </div>
                    <div id="tutorialMessage" class="tutorial-message"></div>
                    <div id="tutorialGrid" class="tutorial-grid"></div>
                </div>
            </div>
            <div id="tutorialExtras" class="tab-panel" data-tab-panel="extras">
                <div class="tutorial-packs" id="tutorialPacks"></div>
            </div>
        </div>
    </div>

    <div id="moreScreen" class="screen screen-wrapper">
        <header class="screen-header">
            <button class="back-btn" onclick="showScreen('home')">
                <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <h2>More</h2>
        </header>
        <div class="screen-content">
            <div class="tabs" id="moreTabs"></div>
            <div id="settingsTab" class="tab-panel active" data-tab-panel="settings">
                <div class="settings-section">
                    <div class="setting-label">theme</div>
                    <div class="theme-options" id="themeOptions"></div>
                </div>
            </div>
            <div id="aboutTab" class="tab-panel" data-tab-panel="about">
                <p style="margin-bottom: 20px;">created by: <strong>Austin Laugesen</strong></p>
                <p style="margin-bottom: 20px;">email: <a href="mailto:alaug@outlook.com" style="color: #1E9FD8; text-decoration: none;">alaug@outlook.com</a></p>
                <p style="margin-bottom: 20px;">version: 1.2026.02.02</p>
            </div>
        </div>
    </div>

    <div id="statsScreen" class="screen screen-wrapper">
        <header class="screen-header">
            <button class="back-btn" onclick="showScreen('home')">
                <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <h2>Stats</h2>
        </header>
        <div class="screen-content">
            <div class="stats-container">
                <div class="stat-card"><div class="stat-value" id="statGamesPlayed">0</div><div class="stat-label">Games Played</div></div>
                <div class="stat-card"><div class="stat-value" id="statHighScore">0</div><div class="stat-label">High Score</div></div>
                <div class="stat-card wide"><div class="stat-value" id="statLongestGame">0s</div><div class="stat-label">Longest Game</div></div>
            </div>
        </div>
    </div>

    <div id="gameContainer" class="screen game-screen">
        <header class="screen-header">
            <button class="back-btn" onclick="clearInterval(timer);showScreen('home')">
                <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <h2>Play</h2>
        </header>
        <div class="screen-content">
            <div id="gameScreen">
                <div class="top-section">
                    <div class="timer-section"><div class="timer">time <span id="timer">60</span>s</div></div>
                    <div class="pattern-section"><div class="pattern-container"><div class="pattern" id="pattern"></div></div></div>
                    <div class="score-section"><div class="score">score <span id="score">0</span></div></div>
                </div>
                <div class="message" id="message"></div>
                <div class="grid" id="grid"></div>
                <div class="game-actions">
                    <div class="action-item" id="hintsAction" onclick="usePowerUp('hints')"><div class="action-count"><span id="hintsCount">5</span></div><div class="action-label">hints</div></div>
                    <div class="action-item" id="skipsAction" onclick="usePowerUp('skips')"><div class="action-count"><span id="skipsCount">5</span></div><div class="action-label">skips</div></div>
                    <div class="action-item" id="timePlusAction" onclick="usePowerUp('timePlus')"><div class="action-count"><span id="timePlusCount">5</span></div><div class="action-label">time +</div></div>
                </div>
            </div>
            <div id="gameOverScreen" style="display: none;" class="game-over">
                <h2>Game Over!</h2>
                <div class="final-score">Final Score: <span id="finalScore">0</span></div>
                <button class="button" onclick="startGame()">Play Again</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        const COLOR_THEMES = [
            ['#7FD45E', '#E8479D', '#FFA826', '#1E9FD8', '#7E8FD4'],
            ['#F5A623', '#7ED4D1', '#EC8C99', '#8FD47E', '#C96565'],
            ['#6B9370', '#B5D4A1', '#A8CEE2', '#D4C89E', '#E8B4B8'],
            ['#2D3436', '#4A5F8C', '#B8C5E0', '#F4E63D', '#9BA653']
        ];
        const GRID_SIZE = 5, SCREENS = ['home', 'tutorial', 'more', 'stats', 'game'];
        let grid = [], pattern = [], selectedSquares = [], score = 0, timeLeft = 60, timer = null;
        let validSolutions = [], hintSquare = null, selectedThemeIndex = 0, currentColors = COLOR_THEMES[0];
        let powerUps = { hints: 5, skips: 5, timePlus: 5 };
        let prevCoords = { leftX: -1, topY: -1, rightX: -1 }, loopIndex = 0, currentSolutionCoords = [];
        let decorativeSquares = [], hiddenDecorativeSquares = [], decorativeTimer = null, decorativeTimerCount = 0;
        let tutorialGrid = [], tutorialPattern = [], tutorialSquares = [], tutorialCurrentSolutionCoords = [];
        let tutorialTimer = null, tutorialAnimationCount = 0;
        let tutorialPrevCoords = { leftX: -1, topY: -1, rightX: -1 }, tutorialLoopIndex = 0;
        let gameStartTime = null;

        // Unified screen navigation
        function showScreen(name, updateHash = true) {
            const screenMap = { home: 'homeScreen', tutorial: 'tutorialScreen', more: 'moreScreen', stats: 'statsScreen', game: 'gameContainer' };
            SCREENS.forEach(s => document.getElementById(screenMap[s]).classList.remove('active'));
            document.getElementById(screenMap[name]).classList.add('active');
            document.body.classList.toggle('game-active', name === 'game' || name === 'tutorial');
            
            if (name === 'home') { stopTutorialAnimation(); startDecorativeTimer(); }
            else { stopDecorativeTimer(); stopTutorialAnimation(); }
            
            if (name === 'tutorial') setActiveTab('tutorialTabs', 'basics');
            if (name === 'stats') loadStats();
            if (name === 'game') startGame();
            
            if (updateHash) history.pushState(null, '', name === 'home' ? window.location.pathname : '#' + (name === 'game' ? 'play' : name));
        }

        // Unified tab handling
        function setActiveTab(containerId, tabKey) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabKey));
            const parent = container.parentElement;
            parent.querySelectorAll('.tab-panel').forEach(p => {
                const isActive = p.dataset.tabPanel === tabKey;
                p.classList.toggle('active', isActive);
                p.style.display = isActive ? 'block' : 'none';
            });
            if (containerId === 'tutorialTabs') tabKey === 'basics' ? startTutorial() : stopTutorialAnimation();
        }

        // Stats management
        function getStats() {
            try { return { gamesPlayed: 0, highScore: 0, longestGame: 0, ...JSON.parse(localStorage.getItem('squaredStats') || '{}') }; }
            catch { return { gamesPlayed: 0, highScore: 0, longestGame: 0 }; }
        }
        function saveStats(s) { try { localStorage.setItem('squaredStats', JSON.stringify(s)); } catch {} }
        function loadStats() {
            const s = getStats();
            document.getElementById('statGamesPlayed').textContent = s.gamesPlayed;
            document.getElementById('statHighScore').textContent = s.highScore;
            document.getElementById('statLongestGame').textContent = s.longestGame + 's';
        }

        // Theme selection
        function selectTheme(index) {
            selectedThemeIndex = index;
            currentColors = COLOR_THEMES[index];
            document.querySelectorAll('.theme-option').forEach((o, i) => {
                o.classList.toggle('selected', i === index);
                o.querySelector('.theme-radio').classList.toggle('selected', i === index);
            });
        }

        // Decorative squares animation
        function initDecorativeSquares() {
            document.querySelectorAll('.decorative-pattern').forEach(p => {
                p.innerHTML = '<div class="decorative-square"></div>'.repeat(4);
            });
            decorativeSquares = Array.from(document.querySelectorAll('.decorative-square'));
            hiddenDecorativeSquares = [];
            decorativeSquares.forEach(s => { s.classList.remove('hidden'); s.dataset.visible = 'true'; });
        }
        function startDecorativeTimer() {
            if (!decorativeSquares.length) initDecorativeSquares();
            if (!decorativeTimer) decorativeTimer = setInterval(decorativeTimerTick, 750);
        }
        function stopDecorativeTimer() { if (decorativeTimer) { clearInterval(decorativeTimer); decorativeTimer = null; } }
        function decorativeTimerTick() {
            if (!decorativeSquares.length) return;
            let idx = Math.floor(Math.random() * decorativeSquares.length), sq = decorativeSquares[idx];
            if (idx % 2 === 0) {
                if (decorativeTimerCount % 2 === 0) { idx = idx === 0 ? Math.min(1, decorativeSquares.length - 1) : idx - 1; sq = decorativeSquares[idx]; decorativeTimerCount = 0; }
                if (sq.dataset.visible === 'true') { sq.classList.add('hidden'); sq.dataset.visible = 'false'; hiddenDecorativeSquares.push(sq); }
            } else if (hiddenDecorativeSquares.length) {
                const next = hiddenDecorativeSquares.shift();
                next.classList.remove('hidden'); next.dataset.visible = 'true';
            }
            decorativeTimerCount++;
        }

        // Tutorial
        function startTutorial() {
            stopTutorialAnimation();
            tutorialAnimationCount = 0; tutorialPrevCoords = { leftX: -1, topY: -1, rightX: -1 }; tutorialLoopIndex = 0;
            tutorialPattern = []; tutorialCurrentSolutionCoords = [];
            tutorialGrid = Array.from({ length: GRID_SIZE * GRID_SIZE }, () => currentColors[Math.floor(Math.random() * currentColors.length)]);
            renderTutorialGrid();
            tutorialPickSolution();
            tutorialTimer = setInterval(tutorialPickSolution, 4500);
        }
        function stopTutorialAnimation() {
            if (tutorialTimer) { clearInterval(tutorialTimer); tutorialTimer = null; }
            tutorialSquares.forEach(s => s.classList.remove('highlight'));
            const msg = document.getElementById('tutorialMessage'), pat = document.getElementById('tutorialPattern');
            if (msg) { msg.style.opacity = 0; msg.textContent = ''; }
            if (pat) pat.innerHTML = '';
        }
        function renderTutorialGrid() {
            const el = document.getElementById('tutorialGrid');
            if (!el) return;
            el.innerHTML = '';
            tutorialSquares = tutorialGrid.map(c => {
                const s = document.createElement('div');
                s.className = 'tutorial-square'; s.style.backgroundColor = c;
                el.appendChild(s); return s;
            });
        }
        function tutorialPickSolution() {
            if (!tutorialGrid.length) return;
            const sideLen = tutorialAnimationCount % 2 === 0 ? 0 : 2;
            getNewPattern(GRID_SIZE, tutorialGrid, sideLen, tutorialPrevCoords, true);
            renderPatternSquares('tutorialPattern', tutorialPattern);
            tutorialSquares.forEach(s => s.classList.remove('highlight'));
            tutorialCurrentSolutionCoords.forEach(i => tutorialSquares[i]?.classList.add('highlight'));
            const msg = document.getElementById('tutorialMessage');
            if (msg) {
                msg.textContent = tutorialCurrentSolutionCoords.length ? (sideLen === 0 ? 'Equidistant squares make a larger outline.' : 'Grouped squares share edges.') : '';
                msg.style.opacity = tutorialCurrentSolutionCoords.length ? 1 : 0;
            }
            tutorialAnimationCount++;
        }

        // Game
        function startGame() {
            score = 0; timeLeft = 60; selectedSquares = []; powerUps = { hints: 5, skips: 5, timePlus: 5 };
            prevCoords = { leftX: -1, topY: -1, rightX: -1 }; loopIndex = 0; currentSolutionCoords = []; validSolutions = [];
            gameStartTime = Date.now();
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';
            updateDisplay(); generateLevel();
        }
        function generateLevel() {
            clearInterval(timer); selectedSquares = []; hintSquare = null; timeLeft = 60;
            grid = Array.from({ length: GRID_SIZE * GRID_SIZE }, () => currentColors[Math.floor(Math.random() * currentColors.length)]);
            getNewPattern(GRID_SIZE, grid, -1, prevCoords, false);
            renderGrid(); renderPatternSquares('pattern', pattern); updateDisplay();
            timer = setInterval(() => { if (--timeLeft <= 0) gameOver(); updateDisplay(); }, 1000);
        }

        // Unified pattern generation
        function getNewPattern(size, gridArr, sideLen, prevCoordsObj, isTutorial) {
            let internalLen = sideLen, startX, startY, leftX, rightX, topY, bottomY, shouldBreak = false, loopCount = 0;
            do {
                do {
                    startX = randInt(0, size - 1); startY = randInt(0, size - 1);
                    internalLen = sideLen === -1 ? randInt(1, Math.max(1, size - startX - 1)) : sideLen === 0 ? randInt(2, Math.max(2, size - 2)) : 1;
                    if (loopCount && loopCount % 5 === 0) {
                        const idx = isTutorial ? tutorialLoopIndex : loopIndex;
                        const mitResult = applyLoopMitigation(idx, size, startX, startY, internalLen);
                        startX = mitResult.x; startY = mitResult.y; internalLen = mitResult.len; shouldBreak = mitResult.brk;
                        if (isTutorial) tutorialLoopIndex = (tutorialLoopIndex + 1) % 9; else loopIndex = (loopIndex + 1) % 9;
                    }
                    const xRes = getXValues(startX, sideLen, internalLen, size, shouldBreak);
                    leftX = xRes.leftX; rightX = xRes.rightX; internalLen = xRes.len;
                    const yRes = getYValues(startY, internalLen, size);
                    topY = yRes.topY; bottomY = yRes.bottomY;
                    loopCount++;
                } while (bottomY >= size || rightX >= size || leftX < 0 || topY < 0 || (leftX === prevCoordsObj.leftX && topY === prevCoordsObj.topY && rightX === prevCoordsObj.rightX));
                
                const tl = topY * size + leftX, tr = topY * size + rightX, bl = bottomY * size + leftX, br = bottomY * size + rightX;
                prevCoordsObj.leftX = leftX; prevCoordsObj.topY = topY; prevCoordsObj.rightX = rightX;
                const patArr = [gridArr[tl], gridArr[tr], gridArr[bl], gridArr[br]];
                const coordsArr = [tl, tr, bl, br];
                if (isTutorial) { tutorialPattern = patArr; tutorialCurrentSolutionCoords = coordsArr; }
                else { pattern = patArr; currentSolutionCoords = coordsArr; validSolutions = [coordsArr.slice()]; }
                return;
            } while (true);
        }

        function applyLoopMitigation(idx, size, x, y, len) {
            const half = Math.floor(size / 2), max = size - 1;
            const configs = [[0,0,len,false],[max,0,len,false],[0,max,len,false],[max,max,len,false],[0,0,1,false],[max,0,1,true],[0,max,1,true],[max,max,1,true],[half,half,1,true]];
            const c = configs[idx] || [x, y, len, false];
            return { x: c[0], y: c[1], len: c[2], brk: c[3] };
        }
        function getXValues(startX, origLen, len, size, simple) {
            let l, r, adj = Math.max(1, len);
            if (size / 2 < startX) { r = startX; if (!simple && origLen === 0) while (r - adj < 0 && adj > 1) adj--; l = r - adj; }
            else { l = startX; if (!simple && origLen === 0) while (l + adj >= size && adj > 1) adj--; r = l + adj; }
            return { leftX: l, rightX: r, len: Math.max(1, adj) };
        }
        function getYValues(startY, len, size) {
            const adj = Math.max(1, len);
            return size / 2 < startY ? { topY: startY - adj, bottomY: startY } : { topY: startY, bottomY: startY + adj };
        }
        function randInt(min, max) { return max < min ? min : Math.floor(Math.random() * (max - min + 1)) + min; }

        function renderGrid() {
            const el = document.getElementById('grid');
            el.innerHTML = '';
            grid.forEach((c, i) => {
                const s = document.createElement('div');
                s.className = 'square'; s.style.backgroundColor = c; s.dataset.index = i;
                s.onclick = () => selectSquare(i);
                el.appendChild(s);
            });
        }
        function renderPatternSquares(id, arr) {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerHTML = '';
            arr.forEach(c => { const s = document.createElement('div'); s.className = 'pattern-square'; s.style.backgroundColor = c; el.appendChild(s); });
        }
        function selectSquare(i) {
            selectedSquares = selectedSquares.includes(i) ? selectedSquares.filter(x => x !== i) : selectedSquares.length < 4 ? [...selectedSquares, i] : selectedSquares;
            updateSquareDisplay(); updateDisplay();
            if (selectedSquares.length === 4) checkSolution();
        }
        function updateSquareDisplay() {
            document.querySelectorAll('.square').forEach(s => {
                const i = +s.dataset.index;
                s.classList.toggle('selected', selectedSquares.includes(i));
                s.classList.toggle('hint', hintSquare === i);
            });
        }
        function checkSolution() {
            const pos = selectedSquares.map(i => ({ i, row: Math.floor(i / GRID_SIZE), col: i % GRID_SIZE })).sort((a, b) => a.row - b.row || a.col - b.col);
            const [tl, tr, bl, br] = pos;
            if (grid[tl.i] !== pattern[0] || grid[tr.i] !== pattern[1] || grid[bl.i] !== pattern[2] || grid[br.i] !== pattern[3]) {
                shakeSquares(); return;
            }
            const dx1 = tr.col - tl.col, dx2 = br.col - bl.col, dy1 = bl.row - tl.row, dy2 = br.row - tr.row;
            if (dx1 === dx2 && dy1 === dy2 && dx1 === dy1) {
                showMessage('Perfect! âœ“', 'success');
                score += 4;
                setTimeout(() => { showMessage('', ''); generateLevel(); }, 300);
            } else shakeSquares();
        }
        function shakeSquares() {
            selectedSquares.forEach(i => {
                const s = document.querySelector(`[data-index="${i}"]`);
                s.classList.add('wrong'); setTimeout(() => s.classList.remove('wrong'), 400);
            });
            setTimeout(() => { selectedSquares = []; updateSquareDisplay(); updateDisplay(); }, 50);
        }
        function gameOver() {
            clearInterval(timer);
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            document.getElementById('finalScore').textContent = score;
            const dur = gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0;
            const s = getStats();
            s.gamesPlayed++; s.highScore = Math.max(s.highScore, score); s.longestGame = Math.max(s.longestGame, dur);
            saveStats(s);
        }
        function showMessage(text, type) {
            const el = document.getElementById('message');
            if (text) { el.textContent = text; el.className = 'message ' + type + ' show'; }
            else { el.classList.remove('show'); setTimeout(() => { el.textContent = ''; el.className = 'message'; }, 300); }
        }
        function updateDisplay() {
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('score').textContent = score;
            ['hints', 'skips', 'timePlus'].forEach(k => {
                const id = k === 'timePlus' ? 'timePlusCount' : k + 'Count';
                document.getElementById(id).textContent = powerUps[k];
                document.getElementById(k === 'timePlus' ? 'timePlusAction' : k + 'Action').classList.toggle('depleted', powerUps[k] === 0);
            });
        }
        function usePowerUp(type) {
            if (powerUps[type] <= 0) return;
            powerUps[type]--;
            if (type === 'hints' && validSolutions.length) {
                hintSquare = validSolutions[Math.floor(Math.random() * validSolutions.length)][0];
                updateSquareDisplay();
                setTimeout(() => { hintSquare = null; updateSquareDisplay(); }, 3000);
            } else if (type === 'skips') generateLevel();
            else if (type === 'timePlus') timeLeft += 10;
            updateDisplay();
        }

        // Hash routing
        function handleHashChange() {
            const h = window.location.hash.slice(1);
            showScreen(h === 'play' ? 'game' : SCREENS.includes(h) ? h : 'home', false);
        }

        // Initialize UI
        function initUI() {
            // Menu buttons
            const menuItems = [{ name: 'Play', screen: 'game' }, { name: 'Stats', screen: 'stats' }, { name: 'Tutorial', screen: 'tutorial' }, { name: 'More', screen: 'more' }];
            document.getElementById('mainMenu').innerHTML = menuItems.map(m => 
                `<button class="menu-button" onclick="showScreen('${m.screen}')"><div class="menu-icon"></div>${m.name}</button>`
            ).join('');
            
            // Tutorial tabs
            document.getElementById('tutorialTabs').innerHTML = ['basics', 'extras'].map(t => 
                `<button class="tab${t === 'basics' ? ' active' : ''}" data-tab="${t}" onclick="setActiveTab('tutorialTabs','${t}')">${t}</button>`
            ).join('');
            
            // Tutorial packs
            const packs = [
                { title: 'Hints', desc: 'Reveal a square within the current pattern so you can lock in on the right spot faster.' },
                { title: 'Skips', desc: 'Move on to a brand new pattern with no penalty if the current board feels tricky.' },
                { title: 'Time +', desc: 'Pause the countdown timer long enough to finish the pattern without pressure.' }
            ];
            document.getElementById('tutorialPacks').innerHTML = packs.map(p => 
                `<div class="tutorial-pack"><div class="tutorial-pack-title">${p.title}</div><div class="tutorial-pack-description">${p.desc}</div></div>`
            ).join('');
            
            // More tabs
            document.getElementById('moreTabs').innerHTML = ['settings', 'about'].map(t => 
                `<button class="tab${t === 'settings' ? ' active' : ''}" data-tab="${t}" onclick="setActiveTab('moreTabs','${t}')">${t}</button>`
            ).join('');
            
            // Theme options
            document.getElementById('themeOptions').innerHTML = COLOR_THEMES.map((theme, i) => 
                `<div class="theme-option${i === 0 ? ' selected' : ''}" data-theme="${i}" onclick="selectTheme(${i})">
                    <div class="theme-preview">${theme.map(c => `<div class="theme-color" style="background:${c}"></div>`).join('')}</div>
                    <div class="theme-radio${i === 0 ? ' selected' : ''}"></div>
                </div>`
            ).join('');
        }

        window.addEventListener('hashchange', handleHashChange);
        document.addEventListener('DOMContentLoaded', () => { initUI(); initDecorativeSquares(); handleHashChange(); });
        if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(e => console.error('SW failed:', e)));
    </script>
</body>
</html>
